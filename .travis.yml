language: go
go:
- 1.12.x
- tip
env:
  global:
  - GO111MODULE=on GOOS=linux GOARCH=amd64
  - TF_IN_AUTOMATION=1
  - VERSION="0.11.13"
  - AWS_DEFAULT_REGION=us-east-1
  - secure: LKH7mGR/71rsxixiL7IkuDJ6KzMEMb6SgtOdxjOiEteYxoTflfstSDglp0ib9thFQyIIQxNI8KMo+rfY26SdBDFrVD2p5nWxV0YF53nwurFZeKCW0+Xc5ahduD6g0sFn5raOn9nxPnWgfksMilDCAWExAslW/X3mfhfm8lECc+v05FOmJNFve8ySPTK+zdtZek4ichHs3ZDBQiV4F4HRhccJugi5w/eFLM/3D7uDgTGHcMpvOa2tbSXBEItr0ClhzxPc+1M2bBDqXtk/liHwxKHtApP8F1Uh4D5zgLU1E2UP8b1e1IXQRELNypPHwEy0HUgYALPWQhoUuGFPFF41wWkz4PFvAFubDQrO4BwH6scOC/51dMUlnp0hSGAAQTDECSSgFEQwdDFHh3QB/hd1uPGBCt501Z2RgSzNmsGAeXUi4OEyw+2r80Op0cEnfy1U9pe/GtvFdD9r+ksT8PH/qbWfA/vIJ2GB1zwnRt/s91vHILZIRQIBmV1aKZVo0xE3u4dO7Zq20zMmpLRX8wneTWTzgi+vpg8YiKB9MF0NN0eOxpBG28tEDgDWOLSaduhxH6bwo2Prf3panI16A+utpkCkmMn3z9tSoZVs02Neisr4OGGFd80tX+zd1xr4ocJ1V4L5AxQRd/uw+tn6efXs5FiD2LM2oNoBcY5fkbkVO8I=
  - secure: vBOjl3E0iXP+8NEtXTg7k9YWwuic9yKuDUIboSxZ8q7UEU4q/QM+QCD/Gl/RMUeZDAGJNbuhSDbheQwiDwbHAgxcuqwW3N8OksSRf6Y/9O8Ei1LyE6nEOlKeO9cNIlGABR0lQ+pY5dSNPOPzMY66yxJKxcZ2/iCsAlch59k/WQR7s6toGjGrpaA88KOkH5GMUXRj2FhY8BVeMuyB0Xb7MtUr6GJB4A+wrk27fJC1zGKZJhsKK3ojJ3I9vqC+CwXI1bkLq+L+jwGb5sEcqnpxbSsVbfceXTXwR3NhZjKm+l8L+zagG43+ecbRFLfIXZXreNojKnGe4qwG5aVPkcDAbFwAalUHKepOUI2ZWgBc3CcRQ8xOX7SEoaMksh0AZciIwEVUzvdkf47YJ61VKCpXKwDgs4V2wjKacspFH5z+0qDEQ14KRREXJc23w0/YKdF6OezEWhu0eG2Ht1X6+CTg1LXKgEbboAW0GtVi0BLjbFRYQU6yKQUjImGfFNmjIm3lfxy7lG2pYL9Xz/q5ANSC2wZL8VLQqPJ4MVFcK8B3scYlzxLajOXQZzGMztp+v0gfyDUkDEcOlIIcRKV2OWbuyCo1v9GBq3q/pirXC22Lzd14h4H0x2CXEmO2B/dThl4qHTrUbMXa12aXL9R+WKKjvmdO1dpxbejr5k2cP+Ra/Cc=
  - secure: owqsBKuP6DeWd5mH+I7O6UhauifL4Fe2KEL/o7Du94+06jMTGNZiSI3qrtLtmk3KAi5VvG0oytXZk/hQIPcc6csjSW+8lLQDcIyGMZkQ9yxhLwTyNsXOhImoBKw3uojYsiwygn60XzZfplbakBd5LX3vzjaCogxg5EZShT2X8e3GoZSTR4t3TE8ycBv18hRGBz0PN+W1AJJJ9cY+W90I+YvhhHek7tb8OiM7WkyCr/jWb/dzPu6tp0zKx4ti32xx+4SLXD2l5P0ThkxGIaIbkhvxsCe/cS1HrP1MEFPZDfJZalGSkMfKr/EUXzbEfIRQOA2xirmxenlQ61hvaT6+ZgI7N/2L+gAGI7PdAMwqOoTmVq8UosIH6bhJ77flfaYph3RGOCRblhwEkSih4NLycGzKRU+/tI8vDYk8L4yQCK6yP8Hjz4ylL9moiKDHqD7TA1XiOatjzIOmm+E2l7Gp3CghGi7Txg5wUAkBlLiVjquxaAZ7LI7pFcFp0JlppUBUbvYiFN6mmKL6uS9AUlmn13o7IEwOJokXCKXno/NfWD/ba4PrO9RLWTGXABNpPhygftmSIy8eKOudJAzxElLK/P67bcXatEi2RBtbIn/ImGdZt70KOE3kNMhB/LhFe4WQZJtZTZF7cVWTjWc0loBjoei22KhG2iZxZvd95q4JxHc=
  - secure: CpqEazNBgah8R94o4W+E0nQW3K4m9U0nGdpwqxl2464SNMZ9OBpvQ2ycR+smjENWij6pskgkHG1wHeL8kpBXr4AOrQiQMPZe89hRCUAulg3dwFVHbfvUZHistSv8iA/eHcbI2gZGEoR721MHEYQu2Em9zSFYS/ZMMWA5kCYgihqHSljpEhINzbGg46gs3ZJ31GmKhfmt0aUhmZU/1z0l9ba/k/lBFjjbnKWQmAwqTdlQqg3LWYOF6i6kW93wVUZuZBnoTWBaMF+410krpUKy9AnV/Y3lE8SIKA4W8UvLV15amZYGLfCfqERS6co1SIXb0XrXIDcQKZ9bM2xRpLJO7lzfYkYY52/wGxveioZVGmJdKBrZwFCEZe/TUkZQKAQfIpArPkHs5Ybk3GzS+VADBpcqLbs6jI4Y5xRBeF7RIBKDaewvs1eUp41dhnnrZJEOu921hYB0VCdgJD874PeGtJcn6KptHMJKSgHekllaWeox1uY0nNsduknX1bUmbeX7UhNheXQuFYtBogT8guPdlnJaxrn9BNvClTHA9iW8fsAQEuOp4R6LhUuLmMHS9xV9A2JyRMb9aQ3XQbEBRr2D4AnVijL+O9Dy2nJmZtCbiJk+q38wZiFDKauqYtfMxdEeh2cCPh88Ga+YnpR9qMDt/Jke0P2H2mshZwNKhsTZ+k4=
  - secure: r94DWiikBxY9TwbjHSeNCNjKeFAocIx5jiWVAcBjfNgo9kISVXaqF57b9SLxoI7XWH7NWBQBtxpXBLwPk4tJLLdX5fK81gDA2Vht2egCWDSPUp+eTFq8MWemzizLTzAMNYUSOpd6v9iOs6vWBIQ2vJdV4QRBK4DfhFrf4Hre7nRvnB4hMTBCM9143x1MRtkbNmIWMKXPj/PLyppIFLd/DQNdMa5nuD2kP3aU0NGJAa7UNOCr99yelaJ5CDLlU0wEe11vu9brUZsDQA6ehd4bs0tk/WanRaQxy7G7U/BnbqaNaYzQoS8TwQapMkAB2Zv7GKOYK/g0mrmSFXqKZv/6pFDOzaG5SpEuDFgaAodGOcRrTFS9Z2jurW+gijdlEF4zRuprW8AVLIVBrwGPi9p0SR1bIw5P9/Mf+/xac8fPXFlXdeyD5Sza7jaBdZ2CtdriPMg33rQ5PTFA3DeEXFdvrUOdNx2BB32UP2Jfby63dp8aPTAxQzjxjVQThYt8jR8QlOB5+6etta3B4x8QVjl23nTlk+OutdseNxNZlSpt5/CP6bw5QVgD+oJWYv/bNscoCeJj5+SxBsqAb1C11IKH57Y+HSup4BoZhDaZ4NSMDuHnDdgjEbh6HgWMgTpxxqJJDlKtx1EOo7gGrrKMJyZJ0VN0yr+Fn6Z9L9xuD74P8Rg=
  - secure: YhpmG+OpjWFdJEdu/6XRi1K6MdNhXKfCeJZq3hTWaYX7lf5Fp+UByGuV55VbU+HTRR3HcHUNxWOyK5sahDLGjfjqffFA70cwaUtNYYolghh9thW8Gfus0o2asPeLBl66jdAcO4svU8k/e9wyNjMCmwlj8BgAGcFPtpR0qVSEGOrNCGNSu4z8m1KtDq25t/M6EJZV+m4z/dwkaAVyf7SMGlrNrF1xpFZPmAq1V5Hc+mfUgACTJ9UZ201+WDwCNRJgP47wMqriGd2lNGJ2ZHZ9ZFPhfa3xoEq7oa9MENhdgQj1fg+ZdE4XOX63B1b3i7gSwCuq04tTyZz3JJKDG7bBf1uqdY3DEijcgDc/kXoi4/WuFak9nXNCRDzJL4rlL2uuh4CTpTqou4m3Iv5K9zB/In0iOrxxlI21ZpWcQXY3yCihEUNKrZYxo3EukI5zI7OLsn97B1yOusarVlQdaHGSWLbQuyJr4ejlUEtj8DY9qm7rzSTrr5jVQHAzPKCcL1aLFfaydD/T1JAq/1yLOCMjeoAyKcNNs8mfKmN6RyW3dBCrafTNubnLYuwXsGIjd80/4CX58UXwdSDMoM021eI1loJT2scygJoRlzFRkBf9/qNny1j7I6Ts924Xj5AkdGC9lLqU0fHyUQW+bhdleyvqjVbSFD9ixFRiJ5kwHK3IuMU=
matrix:
  allow_failures:
  - go: tip
  fast_finish: true
cache:
  directories:
  - "$HOME/.sonar/cache"
addons:
  sonarcloud:
    organization: bhavikkumar-github
    token:
      secure: c5v4OvSRZ7D5z00vE03z/ZvmB7jgf0GZUdRs7C4YZdW1CgxtQkg7pOdIxNO2P01n+awxXFQLgdNQYiLtoJzmGFDVdq+Jdxfp5eplnXMN3M8PC3TwuvZJRdQU3w6ar0dW2sfJAgq3WgCPbfN/9S27vsZaYUSsREox6mVJi4PiKUw4U2P767w8SolpfE6NV3MUnbzdLAtVgV5nn/4Q22T5BAEp6bM6gvPfJdPhfCYqKFysTf/ViZiWP5jfud2rbmmn+Ply7uZ5auoyj2t/nAQiK1uIr8qzvk7A2PRw5HggEgSGMIjTqGzG5ie0tSMr9INdAEUsVNDuVdGNq2/yUR+FQVDyJqbsPIhhwDIiUDncgXPZ/3F7e+2ySqbSR7ljfhjroIjj62Gwq8lBZvQYjURvZUmR6Td0YaHWo1mXg4eYOV39ndI1okYRpEForTbweZ+JVTE7IJQmRFJHiXW7BUXr1Joxd4KCvxtwxwhsqXqvg1fn8smtx5QI2d509HehnUA0BHMvzEXlBqPoT4l9H4AjCYJ38SjJIuzgQXfjeA98gICA5wPpfipG0RDSUgiQavPpst8AzhIUTlwTLehf7cd4NhvkDejOyPAZMNLi0yHhxEwoEU7kYU6fiyfBLvIv8FqkZSbakRDdXJlBPGKYl8OCvcR6YPIJ+gTTvLva0QGuORA=
deploy_lambda: &deploy_lambda
  provider: script
  script: cd deployment && terraform apply -backup="-" -input=false -auto-approve -var aws_default_region=${AWS_DEFAULT_REGION} -var lambda_version=${TRAVIS_TAG} -var account_id=${AWS_ACCOUNT_ID} -var operations_account_id=${OPERATIONS_ACCOUNT_ID} -var role_name=${ROLE_NAME} >/dev/null
  skip_cleanup: true
  on:
    repo: bhavikkumar/cloudwatch-log-destination
    tags: true
    go: 1.12.x
deploy_lambda_stage: &deploy_lambda_stage
  if: tag IS present
  go: 1.12.x
  script: skip
  before_deploy:
    - wget https://releases.hashicorp.com/terraform/${VERSION}/terraform_${VERSION}_linux_amd64.zip
    - unzip -o terraform_${VERSION}_linux_amd64.zip -d $HOME/bin
    - chmod +x $HOME/bin/terraform
    - cd deployment && terraform init -backend-config="bucket=terraform.bhavik.io" -backend-config="region=${AWS_DEFAULT_REGION}" -backend-config="dynamodb_table=terraform-state" -backend-config="kms_key_id=${KMS_KEY_ID}" -backend-config="role_arn=${ROLE_ARN}" >/dev/null
  deploy:
    <<: *deploy_lambda
install:
- go mod download
- go build -ldflags="-s -w" -o main main.go
script:
- go vet ./... 2> govet-report.out
- go test ./... -coverprofile=coverage.out -json > report.json
- sonar-scanner
after_success:
- zip deployment/cloudwatch-log-destination$TRAVIS_TAG.zip main
jobs:
  include:
  - stage: GitHub Release
    if: tag IS present
    go: 1.12.x
    script: skip
    deploy:
      provider: releases
      api_key:
        secure: fiqhQ8z2ts/2/6KxNMsvcN2vdVjRAjclCcFjBxSDdLSulgD2bTa4Fb9OvjLAVhU01Y30e2eoFZ9AVQDeHGibLVisQNHFZlZK0ic6Xr5sK1Jmm50uPDVUE7J1tA+0G25KxavH6dxDUZ/Ict+TvQfZMFRO7hnVZgAnRvqrYd3UfDt0BHZj/ZJobTwgK0Is8Dv996wpj17SWtVzQk9okIsTmqQRD4mO90222I0mlu8kmTfp7edbAy4ZJOStI9m4KBJcD0YGUJrH3XUC27YXLBlThYn9pdYXrSZiAdGnOdtKJeXQydyiAnCDDTJx+EmlsQpOgRUt7ytDKVE3huonvGVyeOCQ3WepGRhhBuBCBLReH2Md1Si5D7F2xCX+4q+m4ES9kYoaK62o1nwhZD+/JkjqgkgYS3z+6+QbY8fa6uITihnwsFZP+yFLPVrKoCxiI4E1LO2AVTEflWPgRFnTFGxRYjrKVd/cT4hZB5GLu/DVlw4fMTYcJS7+Ylv9b89SMQkEP+2zppzLIH4H+011gA4L4nN0xyCvstT0xNFS8xO8J3+EG0mx7wx/uCopOZjPc67lCbl8Pfno+UWUXMkUxo4paDPIb32C0Eoz/fKuGdWNMdznii0jBi9LGQe/8slEBUHGBuM/KN54qhZKHgS0Sd9bBOTI/8FKQyAdK1vQiRt8org=
      file: cloudwatch-log-destination$TRAVIS_TAG.zip
      skip_cleanup: true
      on:
        repo: bhavikkumar/cloudwatch-log-destination
        tags: true
        go: 1.12.x
  - stage: Deploy to Development
    <<: *deploy_lambda_stage
    if: type != pull_request
    env:
    - TF_WORKSPACE=development
    - secure: JwkF+FReR42LjM/azgdNXKMeCa8Kd9LeaBAOyqtmmHXZRVCnskBv/q4cz9x9AueAso3eYRKgicUPg6a1wpcwAZ+LXQmjVKPPh9pXNzt47TsBpE/HCRgqWXLxl/mxMxHTqK67FGGEUeyTDoaQ7A+SyEfOJJstdJsty7OHNF7K3A8h7bb3FXDB2yfAy3fyAn6C5n+MkO3Wa9Ja3g3+ukdPJV45O4dJJ+RKfiHYUnrEaburmKqPmvGbFZxYo6yULSMf9K8sg1V0A2N+94+5R/kbnfoiPJrLAmKunzIlC+A2MtnQgfyiZxJZBHKw+mJoDNQY5TNks7YnViLB+dGsq2JxaHmeLxd5kKRcbB9LzZJ7g6WYQZ9Wt1kTYt3QShZKrz8rSH5vO9OYXclZiYJFuPVtLYm5gRR+EC11tX9V+KFF+MhhSC78ZF0/AhyNYJEhtXAGxnMeT1p1QBUA/A2phooy63UNUa2Y5Jy+AZrxSzNurIpd67NDBDiyJFg/LlUwHlfGWv8A6qqEIeos9NOVrmw/xKIwm9JhVQ50vL9kY7H6w/ICWT8ZFUrG1Zkuv30Ny8pTTrm/Ta9+fMbI2bpq5Duv56HuvaBl2q7NLF5pb3Osy5nPoxBhIl3fEuexKA7oXbzDdQcXfyXcwo9XIFccmscGXDNKjpdOnXLrp+If7z4LFWA=
    deploy:
      <<: *deploy_lambda
      on:
        all_branches: true
        go: 1.12.x
  - stage: Deploy to Master
    <<: *deploy_lambda_stage
    env:
      - TF_WORKSPACE=master
      - secure: JVuRwMH1vw21w3wKtxDzaOfQ1gzL8j7aMlz6IUrJ2NypYFMRgNrmbcsx1uk0Fn8iiZweXv9tfWWZHKYmi4EvgDTIbjd6IlQce08kud/Z8djIJ9LMlO+jHFp7OB1ATlrpIllh4E791rtyFh40L861I0Gk2Wo0AdbFKEPEAt/SckgkOT4McIGFYCKznAboC0P+fUubk4hy+9wv7TZ9aa8zsLwMv53jRzBKy405wnITW49yd/sqHNkA9x1GasPodz2TE12mXZaELdpGfgHpYnsI+diVXsr9d9qLi42IJr2FjKfO0ZCUax7a1odqfl2RPelfkJ1dEoHMDDqXAiqMLqp4LSFVX6JP+dAhgJPaB+w/0woPrn7ZDAv0gVp7T5UKKWYLLOQ8SxM72lWWTbT+UBw7rvDr+Z1FUmjZE55V9sjCwdV8IOwbw9E9bKCF0aEN1BNaA13Q73e6daXnTPa8D9TF+eTSuobmkZ5j7M7Naw0etDpZ2zu0BvbuYDM3y1dD0PAukROBQWKvKzkbzgUZG4960m9G4j+qW4qaP+DxEbVdarIOIq8bLO6K6MGxlSCO4myp33/uPQXhMaeeld/dOLpVk7iVBe2c5If3J+bbg6qImD7rvyRL1tOaCUGZ3OIDUUliS31m1m1wzwNjHryN1hZW/olcyclgzOgQBzl+WPsuwcE=
  - stage: Deploy to Identity
    <<: *deploy_lambda_stage
    env:
      - TF_WORKSPACE=identity
      - secure: tShL7XGoXP+xfs9qtlRd6Yn9MAjrqOB6t9v5GecMgNBw7tkbtxyIZBJP/+0r7Vn93B5XydM64R2uVOH+AZoYDuZ9fLT4NAmOR53P4ysUBXuY/ULksRW0+TuCLEeYfONJb3eMk7yBtalRxVCvVMKF/OilA0TSjY426y02g4nQdzpYocipCVp7BrAK5JBn0Pn2Z0aZ0avuLDqqltzFPRWW949DTAakaxLNihJufyKCL+YMtJcrQQS9qnIdGxXy6Xc5k+VZgbLl8L5d4eS2T5F5QcsFqlxU0dljABq3V2h/HmRNy+Y2yGRp7reVyU7RpZrWh4r3gtcnjo/tkXRLNGoaj7UDA7SFSQAUyKp4RMNHKiYSFfzCcO5as+0zGKDsH4YkADeFzjPT3kMU4XtIU3WdaUKNtjUj/yeRYmnYw9DUXh2wGsAOTPerS/oEecK4Bk6NBcFSsVt4nisG/zDE6alQ+5cLhHW0SMYb+Tbg+ceYvx9MXGBGQsWyjV/etlQJFu+F1NTXj9Os2GIiDgGoQL4soTB284Z/sDy76CMFivkUdCYrQhuELuTMULAju+fKw2EzuerBEQMv8Ti4FSbpqddaM3n82dvEWco40EqZyyTf19lrCZjxm0k8Xz7+43nZ8tT+m+HLtKpg13mztJ38EbfTuc1vVuV+bIyJ3qtPzxNjqFw=
  - stage: Deploy to Operations
    <<: *deploy_lambda_stage
    env:
      - TF_WORKSPACE=operations
      - secure: be0fPruKCzahpu7EKpSgv9FK4Q/8U8H+oSbS8n7YrHwQh7v10MSfDhZoW1Gjz1bKFbclFh9srp1blpXY1Fx5n14OXTzG2pKMqfltUquih80XUOqdV/QPeodc1sao+1iym959SyVSjtKS8XXQZSkchnl/wA6A+K7xU61e3BUPxI4rrmVRw5sTdZlxv/mfmq0/NXRALpqDq7MtpkAXIzNI5YlRH9Q7V63XmlE4cz/0B/+s+xU4By5JhEVj5biL9xaAy1/CkoJwf7NZXpUjEz1T14NrGJzPC2ig9DVCbThMiuN6ajqCE7ZggGFBmzBaw63wbhfZmAcOR9arfuMYo1shtwVxHSpF+FZWlbhaFsS0mKH4Q3E1QK9OUqU1o7eL6iu23dz9BLPJYSgxPsFKXEffUyXW7ScJRpZEtbfdcSntK4IlHXcac7vU6mqn3F8FDWYHGaGaceNy0iGLqIXhyr0FkMKCumZK9lVuPei5uNaaNNbs96PiBoJX17wSYHeT4qo9rFMIOw+8OQYjINyMvsPWXXAM1OOuoQ3j5kjn4eDF4RKIk+duShY4r6Z/zU4d8C3VIKq7m3/UBeAq7lC9swrqED40jdS/QxrEcDaDR+9Ibc/vIiLXGtd5oSiBQLeiqs9r+G5BR6ynUNV1kf+Ye6bnEcX/H1LQWuOUrTOegQnK6Ik=
  - stage: Deploy to Production
    <<: *deploy_lambda_stage
    env:
      - TF_WORKSPACE=production
      - secure: yhzYA58vvyOYm2q9DIEOIGn7JRegpy1vlCtDkQRv/bGXygZ8fotmgvi/fot2GFEKnBrnrFirKCeNhQeNadKUK7rpPmrTLUkrougpr5qIC2ZijLgPnJsK+g5MWNF4VUDX33WbRKYsSI5nTHnoSNir8dK7DyopxIvpVnPoCGvGOI60MKJ2Ff0ak9BoZQyrkd8RG4pfqDP/esNte5KkzXLB/OYw4VcDrP6WFO+q4NPmRroc0PNN3jHRjdHqCY9lHebQfY5W63obYaskJthspu3KEKluvHHNnjsWaUsVF7FBNkMKJVg6MloMzS6uh5rzUF0vbJEWqIzQjP2KuXMO1KBNG9WpikH1JkXxsrJJyiuJWtbEXOeDjljJBGVK+ZK4lhpZwCfblXniT4nuHKogKeu4cPcJ0eN1cuXqi1+fAtr2BUPi1lC78m5jfFCYUpc0X8gnlCKPwT6kMMOrK5bQIYl9iYX/D0UOhJlKEnnbwajDl91wLt1F+DjG27rASzaNJVV3Exp0MlW3toqxXKoKH3E0hrz66upqRZxwjZP9W10xrmR96qZ8pNsFg/+vzblEIOGmJupnM7hkm+lQGkV1Zh9garjii1kuPbY5pMneth7Zq3xCql1qS+akBS6p35R4O6qPSSheZ6NsQgI5IYOR7A+bYSb6HyzGaWwGHExXpYL2Tls=